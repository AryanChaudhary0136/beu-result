<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BEU Result Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#000;
      --card:#0d0d0d;
      --muted:#b5b5b5;
      --accent:#00c8ff;
      --input-bg:#0a0a0a;
      --card-border:#111;
    }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Inter, Arial, sans-serif;color:#fff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box;}
    .card{background:var(--card);padding:26px;border-radius:16px;width:100%;max-width:420px;box-shadow:0 10px 30px rgba(0,200,255,0.06), inset 0 1px 0 rgba(255,255,255,0.02);border:1px solid var(--card-border);box-sizing:border-box;}
    h2{text-align:center;margin:0 0 18px 0;color:var(--accent);font-weight:600;letter-spacing:0.2px;font-size:20px;}
    .field{margin-bottom:12px;}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
    input[type="text"], select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--input-bg);color:#fff;font-size:15px;box-sizing:border-box;outline:none;-webkit-appearance:none;}
    .row{display:flex;gap:10px;}
    .col{flex:1;}
    button{width:100%;padding:12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:700;font-size:15px;cursor:pointer;margin-top:8px;}
    #outBox{margin-top:14px;white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid var(--card-border);max-height:480px;overflow:auto;color:#e6f7ff;font-size:14px;}
    .resultTable{width:100%;border-collapse:collapse;margin-top:8px}
    .resultTable th,.resultTable td{border:1px solid rgba(255,255,255,0.06);padding:10px;text-align:left}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:12px;margin-top:12px}
    .btn-secondary{flex:1;padding:12px;border-radius:10px;border:none;background:#07b39f;color:#000;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-label="BEU Result Viewer">
      <h2>BEU Result Checker</h2>

      <div class="field">
        <label for="redg">Reg. No</label>
        <input id="redg" type="text" inputmode="numeric" placeholder="e.g. 23155150039" autocomplete="off" />
      </div>

      <div class="field">
        <label for="sem">Semester</label>
        <select id="sem" aria-label="Semester">
          <option>I</option><option>II</option><option selected>III</option><option>IV</option><option>V</option><option>VI</option><option>VII</option><option>VIII</option>
        </select>
      </div>

      <div class="row">
        <div class="col field">
          <label for="month">Exam Month</label>
          <select id="month" aria-label="Exam month">
            <option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option selected>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option>
          </select>
        </div>
        <div class="col field">
          <label for="year">Exam Year</label>
          <select id="year" aria-label="Exam year"></select>
        </div>
      </div>

      <button id="go">Get Result</button>

      <div id="msg" class="muted" role="status" aria-live="polite"></div>

      <div id="outBox" aria-live="polite"></div>

      <div class="actions" style="display:block">
        <button id="downloadPdf" class="btn-secondary">Download PDF</button>
      </div>

      <div style="text-align:center;margin-top:12px;color:var(--muted)">Made with ♥ by Aryan</div>
    </div>
  </div>

<script>
  // populate years 2020-2030
  (function(){
    const sel = document.getElementById('year');
    const start=2020,end=2030;
    const cur=new Date().getFullYear();
    for(let y=start;y<=end;y++){
      const o=document.createElement('option'); o.value=y; o.textContent=y;
      if(y===Math.min(Math.max(cur,start),end)) o.selected=true;
      sel.appendChild(o);
    }
  })();

  const apiBase = '/api/result'; // make sure api/result.js exists on Vercel

  document.getElementById('go').addEventListener('click', async ()=>{
    const redg = document.getElementById('redg').value.trim();
    const sem = document.getElementById('sem').value.trim();
    const month = document.getElementById('month').value.trim();
    const year = document.getElementById('year').value.trim();

    if(!redg){ alert('Enter registration number'); return; }

    document.getElementById('msg').textContent = 'Loading...';
    document.getElementById('outBox').innerHTML = '';

    const url = `${apiBase}?redg_no=${encodeURIComponent(redg)}&semester=${encodeURIComponent(sem)}&exam_month=${encodeURIComponent(month)}&exam_year=${encodeURIComponent(year)}`;

    try{
      const r = await fetch(url);
      const j = await r.json();

      document.getElementById('msg').textContent = '';

      if(j.error){ document.getElementById('outBox').textContent = 'Error: ' + j.error; return; }

      const data = j.data || {};
      // If BEU returned raw HTML/text:
      if(data.raw){
        document.getElementById('outBox').textContent = 'Server returned non-JSON response. Look in console for raw output.';
        console.log('RAW BEU RESPONSE:', data.raw);
        return;
      }

      // Format output exactly like your PDF sample.
      // Top info table:
      const tbl = document.createElement('table');
      tbl.className = 'resultTable';
      tbl.innerHTML = `
        <tr><th>Registration No:</th><td>${escapeHtml(data.redg_no || redg || '')}</td></tr>
        <tr><th>Semester:</th><td>${escapeHtml(data.semester || sem || '')}</td></tr>
        <tr><th>Name:</th><td>${escapeHtml(data.name || data.student_name || '')}</td></tr>
        <tr><th>Exam:</th><td>${escapeHtml(data.exam_held || (month + '/' + year) || '')}</td></tr>
        <tr><th>College:</th><td>${escapeHtml(data.college_name || data.college || '')}</td></tr>
        <tr><th>Course:</th><td>${escapeHtml(data.course || data.course_name || '')}</td></tr>
      `;

      // Subjects table (theory + practical)
      const subjList = [];
      if(Array.isArray(data.theorySubjects)) subjList.push(...data.theorySubjects);
      if(Array.isArray(data.practicalSubjects)) subjList.push(...data.practicalSubjects);
      if(Array.isArray(data.subjects)) subjList.push(...data.subjects);
      if(Array.isArray(data.results)) subjList.push(...data.results);
      // Remove duplicates by code
      const byCode = {};
      subjList.forEach(s=>{ if(s && s.code) byCode[s.code]=s; });
      const subjects = Object.values(byCode);

      let subjectsHtml = '';
      if(subjects.length){
        subjectsHtml += `<h3 style="margin-top:12px">Subjects</h3><table class="resultTable"><thead><tr><th>Code</th><th>Subject</th><th>IA</th><th>ESE</th><th>Total</th><th>Grade</th></tr></thead><tbody>`;
        subjects.forEach(s=>{
          const code = s.code||'';
          const name = s.name||s.subject||'';
          const ia = s.ia ?? s.internal ?? '';
          const ese = s.ese ?? s.exam ?? '';
          const total = s.total ?? '';
          const grade = s.grade ?? s.result ?? '';
          subjectsHtml += `<tr><td>${escapeHtml(code)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(String(ia))}</td><td>${escapeHtml(String(ese))}</td><td>${escapeHtml(String(total))}</td><td>${escapeHtml(String(grade))}</td></tr>`;
        });
        subjectsHtml += `</tbody></table>`;
      }

      // SGPA / CGPA: prefer direct fields if present
      const sgpa = data.sgpa && Array.isArray(data.sgpa) ? data.sgpa[data.sgpa.length-1] : (data.sgpa || null);
      const cgpa = data.cgpa || data.CGPA || null;

      const sgpaLine = `<p style="margin-top:12px"><strong>SGPA / CGPA:</strong> ${escapeHtml(String(cgpa || sgpa || 'N/A'))}</p>`;

      const container = document.getElementById('outBox');
      container.innerHTML = '';
      container.appendChild(tbl);
      container.insertAdjacentHTML('beforeend', subjectsHtml);
      container.insertAdjacentHTML('beforeend', sgpaLine);

      // Save latest result for PDF download
      window.latestResultData = { header: {
        reg: data.redg_no || redg,
        semester: data.semester || sem,
        name: data.name || data.student_name || '',
        exam: data.exam_held || (month + '/' + year),
        college: data.college_name || data.college || '',
        course: data.course || data.course_name || ''
      }, subjects, cgpa: cgpa || sgpa || null };

    }catch(err){
      document.getElementById('msg').textContent = '';
      document.getElementById('outBox').textContent = 'Fetch error: ' + (err.message || err);
    }
  });

  // Download PDF — simple print-style
  document.getElementById('downloadPdf').addEventListener('click', ()=>{
    const d = window.latestResultData;
    if(!d){ alert('Pehle result fetch karo'); return; }
    const header = `<h2 style="color:#00c8ff">BEU Result</h2>
      <p><strong>Registration No:</strong> ${escapeHtml(d.header.reg)} &nbsp; <strong>Semester:</strong> ${escapeHtml(d.header.semester)}</p>
      <p><strong>Name:</strong> ${escapeHtml(d.header.name)}</p>
      <p><strong>Exam:</strong> ${escapeHtml(d.header.exam)} &nbsp; <strong>College:</strong> ${escapeHtml(d.header.college)}</p>
      <hr/>`;

    let subjectsHtml = '<table style="width:100%;border-collapse:collapse">';
    subjectsHtml += '<tr><th style="border:1px solid #ccc;padding:6px">Code</th><th style="border:1px solid #ccc;padding:6px">Subject</th><th style="border:1px solid #ccc;padding:6px">IA</th><th style="border:1px solid #ccc;padding:6px">ESE</th><th style="border:1px solid #ccc;padding:6px">Total</th><th style="border:1px solid #ccc;padding:6px">Grade</th></tr>';
    (d.subjects || []).forEach(s=>{
      subjectsHtml += `<tr>
        <td style="border:1px solid #ccc;padding:6px">${escapeHtml(s.code||'')}</td>
        <td style="border:1px solid #ccc;padding:6px">${escapeHtml(s.name||'')}</td>
        <td style="border:1px solid #ccc;padding:6px">${escapeHtml(String(s.ia||''))}</td>
        <td style="border:1px solid #ccc;padding:6px">${escapeHtml(String(s.ese||''))}</td>
        <td style="border:1px solid #ccc;padding:6px">${escapeHtml(String(s.total||''))}</td>
        <td style="border:1px solid #ccc;padding:6px">${escapeHtml(String(s.grade||''))}</td>
      </tr>`;
    });
    subjectsHtml += '</table>';

    const footer = `<p style="margin-top:12px"><strong>SGPA / CGPA:</strong> ${escapeHtml(String(d.cgpa || 'N/A'))}</p>`;

    const win = window.open('', '_blank', 'width=900,height=700');
    win.document.write(`<html><head><meta charset="utf-8"><title>BEU Result</title></head><body style="font-family:Arial;padding:18px;color:#000">${header}${subjectsHtml}${footer}</body></html>`);
    win.document.close();
    setTimeout(()=>{ win.print(); }, 500);
  });

  function escapeHtml(s){
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
</script>
</body>
</html>
