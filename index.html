<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BEU Result Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#000;
      --card:#0d0d0d;
      --muted:#b5b5b5;
      --accent:#00c8ff;
      --input-bg:#0a0a0a;
      --card-border:#111;
    }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Inter,Arial,sans-serif;color:#fff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
    .card{background:var(--card);padding:24px;border-radius:16px;width:100%;max-width:440px;box-shadow:0 10px 30px rgba(0,200,255,0.06);border:1px solid var(--card-border)}
    h2{text-align:center;margin:0 0 14px;color:var(--accent);font-weight:700}
    .field{margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"],select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--input-bg);color:#fff;font-size:15px;box-sizing:border-box;outline:none}
    .row{display:flex;gap:10px}
    .col{flex:1}
    button{width:100%;padding:14px;border-radius:12px;border:none;background:var(--accent);color:#000;font-weight:700;font-size:16px;cursor:pointer;margin-top:8px}
    #outBox{margin-top:14px;white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid var(--card-border);max-height:360px;overflow:auto;color:#e6f7ff;font-size:14px}
    #msg{ text-align:center;margin-top:10px;color:var(--accent);font-size:13px }
    .small{font-size:13px;color:#9ea9b0;margin-top:10px;text-align:center}
    @media (max-width:420px){.card{padding:18px;border-radius:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-label="BEU Result Viewer">
      <h2>BEU Result Checker</h2>

      <div class="field">
        <label for="redg">Reg. No</label>
        <input id="redg" type="text" inputmode="numeric" pattern="\d*" placeholder="e.g. 23155150039" autocomplete="off" />
      </div>

      <div class="field">
        <label for="sem">Semester</label>
        <select id="sem" aria-label="Semester">
          <option>I</option><option>II</option><option selected>III</option><option>IV</option><option>V</option><option>VI</option><option>VII</option><option>VIII</option>
        </select>
      </div>

      <div class="row">
        <div class="col field">
          <label for="month">Exam Month</label>
          <select id="month" aria-label="Exam month">
            <option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option>
            <option selected>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option>
          </select>
        </div>
        <div class="col field">
          <label for="year">Exam Year</label>
          <select id="year" aria-label="Exam year"></select>
        </div>
      </div>

      <button id="go">Get Result</button>

      <div id="msg" role="status" aria-live="polite"></div>
      <div id="outBox" aria-live="polite"></div>

      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="downloadJson" style="flex:1;background:#0b9bd8">Download JSON</button>
        <button id="downloadPdf" style="flex:1;background:#06b0a6">Download PDF</button>
      </div>

      <div class="small">Made with ♥ by Aryan</div>
    </div>
  </div>

<script>
  // populate years 2020-2030
  (function(){
    const sel = document.getElementById('year');
    const start = 2020, end = 2030;
    const cur = new Date().getFullYear();
    for(let y=start;y<=end;y++){
      const o = document.createElement('option');
      o.value = String(y); o.textContent = String(y);
      if(y === Math.min(Math.max(cur, start), end)) o.selected = true;
      sel.appendChild(o);
    }
  })();

  const apiBase = '/api/result'; // Vercel route: api/result.js
  let latestData = null;

  async function fetchResult(){
    const redg = document.getElementById('redg').value.trim();
    const sem  = document.getElementById('sem').value.trim();
    const month = document.getElementById('month').value.trim();
    const year = document.getElementById('year').value.trim();

    if(!redg){ alert('Registration number daalo'); return; }

    document.getElementById('msg').textContent = 'Loading...';
    document.getElementById('outBox').textContent = '';

    const url = `${apiBase}?redg_no=${encodeURIComponent(redg)}&semester=${encodeURIComponent(sem)}&month=${encodeURIComponent(month)}&year=${encodeURIComponent(year)}`;

    try {
      const res = await fetch(url);
      // if response not ok, still try to read body
      const text = await res.text();
      let j;
      try { j = JSON.parse(text); }
      catch { j = { data: { raw: text }, parseError: true }; }

      document.getElementById('msg').textContent = '';
      if (j.error) {
        document.getElementById('outBox').textContent = 'Error: ' + (j.error || JSON.stringify(j));
        latestData = j;
        return;
      }

      const data = j.data || {};
      latestData = data;

      // if parsed JSON from BEU
      if (!data.raw && typeof data === 'object') {
        // friendly formatting: show name, reg_no, subjects table if present, else pretty JSON
        let html = '';
        if (data.name) html += `Name: ${data.name}\n`;
        if (data.redg_no || data.reg_no) html += `Reg No: ${data.redg_no || data.reg_no}\n`;
        html += '\n';

        // try theory/practical arrays heuristics
        const lists = data.theorySubjects || data.practicalSubjects || data.subjects || data.results || null;

        if (Array.isArray(data.theorySubjects) || Array.isArray(data.practicalSubjects)) {
          function formatList(arr){
            let s = '';
            for(const it of arr){
              const nm = it.name || it.subject || it.paper || it.code || JSON.stringify(it);
              const tot = it.total ?? it.obtained ?? it.ese ?? it.ia ?? '';
              s += `${nm}  —  ${tot}\n`;
            }
            return s;
          }
          if (Array.isArray(data.theorySubjects)) html += 'Theory:\n' + formatList(data.theorySubjects) + '\n';
          if (Array.isArray(data.practicalSubjects)) html += 'Practical:\n' + formatList(data.practicalSubjects) + '\n';
        } else if (Array.isArray(lists)) {
          html += lists.map(s => `${s.name || s.subject || s.code} — ${s.total ?? s.marks ?? ''}`).join('\n') + '\n';
        } else {
          html += JSON.stringify(data, null, 2);
        }

        document.getElementById('outBox').textContent = html;
      } else if (data.raw) {
        // raw HTML/text from BEU
        document.getElementById('outBox').textContent = data.raw;
      } else {
        document.getElementById('outBox').textContent = JSON.stringify(j, null, 2);
      }
    } catch (err) {
      document.getElementById('msg').textContent = '';
      document.getElementById('outBox').textContent = 'Fetch error: ' + (err.message || err);
    }
  }

  document.getElementById('go').addEventListener('click', fetchResult);
  document.getElementById('redg').addEventListener('keydown', e => { if (e.key === 'Enter') fetchResult(); });

  // Download JSON
  document.getElementById('downloadJson').addEventListener('click', () => {
    const data = latestData || {};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    const r = document.getElementById('redg').value.trim() || 'result';
    a.download = `beu_result_${r}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Download PDF (print)
  document.getElementById('downloadPdf').addEventListener('click', () => {
    const redg = document.getElementById('redg').value.trim();
    const month = document.getElementById('month').value.trim();
    const year = document.getElementById('year').value.trim();
    const header = `<h2 style="color:#00c8ff">BEU Result</h2><p><strong>Reg:</strong> ${redg} &nbsp; <strong>Exam:</strong> ${month}/${year}</p><hr>`;
    const body = `<pre>${escapeHtml(document.getElementById('outBox').textContent || JSON.stringify(latestData || {}, null, 2))}</pre>`;
    const styles = `<style>body{background:#fff;color:#000;font-family:Arial;padding:18px} pre{white-space:pre-wrap}</style>`;
    const w = window.open('', '_blank', 'width=900,height=700');
    w.document.open();
    w.document.write(`<html><head>${styles}</head><body>${header}${body}</body></html>`);
    w.document.close();
    w.focus();
    setTimeout(()=> w.print(), 600);
  });

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>