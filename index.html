<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BEU Result Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#000;
      --card:#0d0d0d;
      --muted:#b5b5b5;
      --accent:#00c8ff;
      --input-bg:#0a0a0a;
      --card-border:#111;
    }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Inter,Arial,sans-serif;color:#fff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
    .card{background:var(--card);padding:26px;border-radius:16px;width:100%;max-width:420px;box-shadow:0 10px 30px rgba(0,200,255,0.06);border:1px solid var(--card-border);box-sizing:border-box}
    h2{text-align:center;margin:0 0 18px;color:var(--accent);font-weight:600;font-size:20px}
    .field{margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:var(--input-bg);color:#fff;font-size:15px;box-sizing:border-box;outline:none}
    .row{display:flex;gap:10px}
    .col{flex:1}
    button.primary{width:100%;padding:12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:700;font-size:15px;cursor:pointer;margin-top:8px}
    #outBox{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid var(--card-border);max-height:320px;overflow:auto;color:#e6f7ff;font-size:14px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .btn{flex:1;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.json{background:#00b0ff;color:#000}
    .btn.pdf{background:#00cfa0;color:#000}
    .meta{color:#9fbac6;text-align:center;margin-top:12px;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px;color:#e8f8ff}
    th,td{border:1px solid rgba(255,255,255,0.06);padding:8px;text-align:left;font-size:13px}
    th{background:rgba(255,255,255,0.02);color:var(--muted)}
    @media (max-width:420px){.card{padding:18px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-label="BEU Result Viewer">
      <h2>BEU Result Checker</h2>

      <div class="field">
        <label for="redg">Reg. No</label>
        <input id="redg" type="text" inputmode="numeric" placeholder="e.g. 23155150039" />
      </div>

      <div class="field">
        <label for="sem">Semester</label>
        <select id="sem" aria-label="Semester">
          <option>I</option><option>II</option><option selected>III</option><option>IV</option>
          <option>V</option><option>VI</option><option>VII</option><option>VIII</option>
        </select>
      </div>

      <div class="row">
        <div class="col field">
          <label for="month">Exam Month</label>
          <select id="month">
            <option>January</option><option>February</option><option>March</option><option>April</option>
            <option>May</option><option>June</option><option selected>July</option><option>August</option>
            <option>September</option><option>October</option><option>November</option><option>December</option>
          </select>
        </div>
        <div class="col field">
          <label for="year">Exam Year</label>
          <select id="year"></select>
        </div>
      </div>

      <button id="go" class="primary">Get Result</button>

      <div id="msg" role="status" aria-live="polite"></div>
      <div id="outBox" aria-live="polite"></div>

      <div class="actions" id="downloadActions" style="display:none">
        <button id="downloadJson" class="btn json">Download JSON</button>
        <button id="downloadPdf" class="btn pdf">Download PDF</button>
      </div>

      <div class="meta">Made with ♥ by Aryan</div>
    </div>
  </div>

<script>
  // populate years 2020-2030
  (function(){
    const sel = document.getElementById('year');
    for(let y=2020;y<=2030;y++){
      const o = document.createElement('option'); o.value = y; o.textContent = y;
      if(y===2025) o.selected = true;
      sel.appendChild(o);
    }
  })();

  const apiBase = '/api/result'; // ensure api/result.js is in /api folder on your repo
  const outBox = document.getElementById('outBox');
  const downloadActions = document.getElementById('downloadActions');

  document.getElementById('go').addEventListener('click', fetchResult);
  document.getElementById('redg').addEventListener('keydown', e => { if(e.key==='Enter') fetchResult(); });

  async function fetchResult(){
    const redg = document.getElementById('redg').value.trim();
    if(!redg){ alert('Enter registration number'); return; }
    const sem = document.getElementById('sem').value.trim();
    const month = document.getElementById('month').value.trim();
    const year = document.getElementById('year').value.trim();
    const exam_held = `${month}/${year}`;

    outBox.textContent = 'Loading...';
    downloadActions.style.display = 'none';

    const url = `${apiBase}?redg_no=${encodeURIComponent(redg)}&semester=${encodeURIComponent(sem)}&year=${encodeURIComponent(year)}&exam_held=${encodeURIComponent(exam_held)}`;
    try{
      const r = await fetch(url);
      const j = await r.json();

      if(j.error){ outBox.textContent = 'Error: ' + j.error; return; }
      const data = j.data;

      // If API returned raw HTML/text, show raw and stop (safe fallback)
      if(data && data.raw){
        outBox.innerHTML = `<strong>Raw response (showing text):</strong>\n\n<pre style="white-space:pre-wrap;color:#fff">${escapeHtml(data.raw)}</pre>`;
        window.latestResult = data;
        downloadActions.style.display = 'flex';
        return;
      }

      // Format structured JSON into clean view (following PDF layout)
      const html = renderResultClean(data);
      outBox.innerHTML = html;
      window.latestResult = data;
      downloadActions.style.display = 'flex';
    }catch(err){
      outBox.textContent = 'Fetch error: ' + (err.message || err);
    }
  }

  // formatting helper - builds student info + tables like PDF sample (see uploaded PDF). 1
  function renderResultClean(data){
    if(!data) return '<pre>No data</pre>';
    // header info (some keys may vary)
    const name = data.name || data.student_name || (data.student && data.student.name) || '';
    const reg = data.redg_no || data.reg_no || data.registration_no || '';
    const father = data.father_name || '';
    const mother = data.mother_name || '';
    const college = (data.college_name || data.collge || data.college || '') ;
    const course = data.course || data.course_name || '';

    let html = `<div><table style="width:100%;margin-bottom:10px"><tr><td><strong>Registration No:</strong> ${escapeHtml(reg)}</td><td style="text-align:right"><strong>Semester:</strong> ${escapeHtml(data.semester||'')}</td></tr>
    <tr><td><strong>Name:</strong> ${escapeHtml(name)}</td><td style="text-align:right"><strong>Exam:</strong> ${escapeHtml(data.exam_held||'')}</td></tr>
    <tr><td><strong>College:</strong> ${escapeHtml(college)}</td><td style="text-align:right"><strong>Course:</strong> ${escapeHtml(course)}</strong></td></tr></table>`;

    // Theory subjects
    const theory = data.theorySubjects || data.theory || data.results || data.subjects || [];
    if(Array.isArray(theory) && theory.length){
      html += `<h4 style="margin:6px 0;color:var(--muted)">Theory</h4><table><thead><tr><th>Code</th><th>Subject</th><th>ESE</th><th>IA</th><th>Total</th><th>Grade</th></tr></thead><tbody>`;
      theory.forEach(s => {
        const code = s.code || s.subject_code || '';
        const nameS = s.name || s.subject_name || s.subject || '';
        const ese = s.ese ?? s.ESE ?? '';
        const ia = s.ia ?? s.IA ?? '';
        const total = s.total ?? '';
        const grade = s.grade ?? '';
        html += `<tr><td>${escapeHtml(code)}</td><td>${escapeHtml(nameS)}</td><td>${escapeHtml(String(ese))}</td><td>${escapeHtml(String(ia))}</td><td>${escapeHtml(String(total))}</td><td>${escapeHtml(String(grade))}</td></tr>`;
      });
      html += `</tbody></table>`;
    }

    // Practical subjects
    const practical = data.practicalSubjects || data.practical || data.practicals || [];
    if(Array.isArray(practical) && practical.length){
      html += `<h4 style="margin:6px 0;color:var(--muted)">Practical</h4><table><thead><tr><th>Code</th><th>Subject</th><th>ESE</th><th>IA</th><th>Total</th><th>Grade</th></tr></thead><tbody>`;
      practical.forEach(s => {
        const code = s.code || '';
        const nameS = s.name || '';
        const ese = s.ese ?? '';
        const ia = s.ia ?? '';
        const total = s.total ?? '';
        const grade = s.grade ?? '';
        html += `<tr><td>${escapeHtml(code)}</td><td>${escapeHtml(nameS)}</td><td>${escapeHtml(String(ese))}</td><td>${escapeHtml(String(ia))}</td><td>${escapeHtml(String(total))}</td><td>${escapeHtml(String(grade))}</td></tr>`;
      });
      html += `</tbody></table>`;
    }

    // SGPA / CGPA
    const sgpa = data.sgpa || data.SGPA || data.sgpa_list || [];
    const cgpa = data.cgpa || data.CGPA || data.cur_cgpa || data.cur_cgpa || data.cur_cgpa;
    html += `<div style="margin-top:8px"><strong>SGPA / CGPA:</strong> ${escapeHtml(String(cgpa || (data.cgpa || 'N/A')))} `;
    if(Array.isArray(sgpa) && sgpa.length) html += `<br><small>SGPA: ${escapeHtml(String(sgpa.join(', ')))}</small>`;
    html += `</div>`;

    // Remarks
    if(data.remarks || data.remark || data.fail_any || data.result){
      const rem = data.remarks || data.remark || data.fail_any || data.result || '';
      html += `<div style="margin-top:8px"><strong>Remarks:</strong> ${escapeHtml(String(rem))}</div>`;
    }

    html += `</div>`;
    return html;
  }

  // download JSON
  document.getElementById('downloadJson').addEventListener('click', () => {
    const data = window.latestResult || {};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `beu_result.json`; a.click(); URL.revokeObjectURL(url);
  });

  // download PDF -> opens print dialog with formatted content
  document.getElementById('downloadPdf').addEventListener('click', () => {
    const header = `<h2 style="color:${'#00c8ff'};text-align:center">BEU Result</h2>`;
    const content = document.getElementById('outBox').innerHTML || '<pre>No data</pre>';
    const styles = `<style>body{font-family:Arial;padding:18px} table{width:100%;border-collapse:collapse} table td,table th{border:1px solid #ddd;padding:6px}</style>`;
    const w = window.open('', '_blank', 'width=900,height=700');
    w.document.open(); w.document.write(`<html><head>${styles}</head><body>${header}${content}</body></html>`); w.document.close();
    setTimeout(()=>{ w.print(); }, 500);
  });

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
